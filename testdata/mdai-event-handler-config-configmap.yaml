apiVersion: v1
kind: ConfigMap
metadata:
  name: mdai-event-handler-config
  namespace: mdai
data:
  config.yaml: |
    variables:
      - storageKey: service_list
        defaultValue: "n/a"
        with:
          - exportedVariableName: "SERVICE_LIST_REGEX"
            transformer:
              join:
                delimiter: "|"
          - exportedVariableName: "SERVICE_LIST_CSV"
            transformer:
              join:
                delimiter: ","
        # below properties are optional
        type: set
        storageType: "mdai-valkey"
    
    evaluations:
      - name: logBytesOutTooHighBySvc
        type: mdai/prometheus_alert
        expr: "(increase(mdai_log_bytes_sent_total[1h]) > 100*1024*1024) by service_name"
        severity: warning
        status:
          firing:
            variableUpdate:
              variableRef: service_list
              operation: mdai/add_element
          resolved:
            variableUpdate:
              variableRef: service_list
              operation: mdai/remove_element
        # Optional below here
        for: 5m
        keep_firing_for: 10m
        relevantLabels:
          - "service_name"
